<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="aiPopup">
    <style>
        /* ì±—ë´‡ í† ê¸€ ë²„íŠ¼ */
        #ai-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #46a500;
            opacity: 0.9;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 9999;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        #ai-toggle-btn:hover {
            transform: scale(1.1);
            background-color: #54c700;
        }

        /* ì±—ë´‡ íŒì—… ì°½ */
        #ai-chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 600px; /* íƒ­ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ì¡°ê¸ˆ ëŠ˜ë¦¼ */
            background-color: #1a1a1a; /* ì „ì²´ ë°°ê²½ ì–´ë‘¡ê²Œ í†µì¼ */
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #333;
            font-family: 'Pretendard', sans-serif;
        }

        /* íŒì—… í—¤ë” */
        .ai-popup-header {
            background-color: #54c700;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-popup-close {
            cursor: pointer;
            font-size: 20px;
        }

        /* [ì¶”ê°€ë¨] ëª¨ë“œ ì „í™˜ íƒ­ */
		.ai-popup-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2ì—´ ê·¸ë¦¬ë“œ */
            background-color: #2a2a2a;
            border-bottom: 1px solid #333;
        }

        .ai-popup-tab-btn {
            background: none;
            border: none;
            padding: 10px 5px; /* ë‚´ë¶€ ì—¬ë°± ì¡°ì ˆ */
            color: #888;
            font-size: 13px; /* ê¸€ì í¬ê¸° ì‚´ì§ ì¶•ì†Œ */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            border-right: 1px solid #333; /* ë²„íŠ¼ ì‚¬ì´ êµ¬ë¶„ì„  */
            border-top: 1px solid #333;
        }
        
        /* ì˜¤ë¥¸ìª½ ë ë²„íŠ¼ì˜ ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ ì œê±° (ì§ìˆ˜ ë²ˆì§¸ ìì‹) */
        .ai-popup-tab-btn:nth-child(2n) {
            border-right: none;
        }
        /* ì²« ë²ˆì§¸ ì¤„ì˜ ìœ„ìª½ í…Œë‘ë¦¬ ì œê±° */
        .ai-popup-tab-btn:nth-child(1), .ai-popup-tab-btn:nth-child(2) {
            border-top: none;
        }

        .ai-popup-tab-btn:hover {
            color: #ccc;
            background-color: #333; /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ì‚´ì§ ë³€ê²½ */
        }

        .ai-popup-tab-btn.active {
            color: #54c700;
            border-bottom-color: #54c700;
            background-color: #222; /* í™œì„±í™”ëœ íƒ­ ë°°ê²½ */
        }

        /* ì±„íŒ… ì˜ì—­ */
        #popupChatBox {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #000000;
        }

        .popup-message-row { display: flex; }

        .popup-message-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 14px;
        }

        .popup-message-row.user { justify-content: flex-end; }
        .popup-message-row.user .popup-message-bubble {
            background-color: #54c700;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .popup-message-row.model { justify-content: flex-start; }
        .popup-message-row.model .popup-message-bubble {
            background-color: #333;
            color: #f1f1f1;
            border-bottom-left-radius: 2px;
            white-space: pre-wrap;
        }
        
        .popup-message-row.loading .popup-message-bubble {
            background-color: #444;
            color: #aaa;
            font-style: italic;
        }

        /* [ì¶”ê°€ë¨] ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ ì˜ì—­ */
        .ai-popup-suggestion-area {
            padding: 10px 15px;
            background-color: #000000; /* ì±„íŒ…ì°½ ë°°ê²½ê³¼ ë™ì¼í•˜ê²Œ */
            display: flex;
            gap: 8px;
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            white-space: nowrap;
            /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .ai-popup-suggestion-area::-webkit-scrollbar { 
            display: none; 
        }

        .ai-popup-suggestion-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 12px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; /* ë²„íŠ¼ ì¤„ì–´ë“¤ì§€ ì•Šê²Œ */
        }

        .ai-popup-suggestion-btn:hover {
            border-color: #54c700;
            color: #54c700;
            background-color: rgba(84, 199, 0, 0.1);
        }

        /* ì…ë ¥ ì˜ì—­ */
        .ai-popup-input-area {
            padding: 10px 15px 15px 15px;
            background-color: #000000;
            border-top: 1px solid #222;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ai-popup-input-area textarea {
            flex-grow: 1;
            border: 1px solid #444;
            background-color: #222;
            color: white;
            border-radius: 20px;
            padding: 10px 15px;
            height: 40px;
            max-height: 80px;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .ai-popup-input-area textarea:focus {
            border-color: #54c700;
        }

        .ai-popup-input-area button {
            background-color: #54c700;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .ai-popup-input-area button:hover {
            background-color: #46a500;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            #ai-chat-window {
                width: 90%;
                right: 5%;
                bottom: 90px;
                height: 70vh;
            }
        }
    </style>

    <button id="ai-toggle-btn" onclick="toggleAiPopup()">
        ğŸ’¬
    </button>

    <div id="ai-chat-window">
        <div class="ai-popup-header">
            <span>ğŸ¤– AI ë¶€ë™ì‚° ë¹„ì„œ</span>
            <span class="ai-popup-close" onclick="toggleAiPopup()">&times;</span>
        </div>

        <div class="ai-popup-tabs">
            <button class="ai-popup-tab-btn active" id="popup-tab-chat" onclick="setPopupMode('chat')">ğŸ“Š ë¶„ì„ ìƒë‹´</button>
            <button class="ai-popup-tab-btn" id="popup-tab-recommend" onclick="setPopupMode('recommend')">ğŸ“ ê¸€ ì¶”ì²œ</button>
    		<button class="ai-popup-tab-btn" id="popup-tab-policy" onclick="setPopupMode('policy')">ğŸ“ ì •ì±… ê²€ìƒ‰</button>
			<button class="ai-popup-tab-btn" id="popup-tab-term" onclick="setPopupMode('term')">ğŸ“• ìš©ì–´ ê²€ìƒ‰</button>
		</div>

        <div id="popupChatBox">
            <div class="popup-message-row model">
                <div class="popup-message-bubble">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
            </div>
        </div>

        <div class="ai-popup-suggestion-area" id="popupSuggestionArea">
            <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì„œì›êµ¬ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ì„œì›êµ¬ ê±°ë˜ë‚´ì—­</button>
            <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ê±°ì£¼ì ì¸ ì¸¡ë©´ì—ì„œ ì„œì›êµ¬ ì–´ë•Œ?')">ì„œì›êµ¬ ê±°ì£¼ê°€ì¹˜</button>
            <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì„œì›êµ¬ íˆ¬ìí•˜ê¸° ì¢‹ì•„?')">ì„œì›êµ¬ íˆ¬ìì „ë§</button>
        </div>

        <div class="ai-popup-input-area">
            <textarea id="popupMessage" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <button id="popupSendBtn">â¤</button>
        </div>
    </div>

    <script th:inline="none">
        const popupChatBox = document.getElementById("popupChatBox");
        const popupMessageInput = document.getElementById("popupMessage");
        const popupSendBtn = document.getElementById("popupSendBtn");
        const aiChatWindow = document.getElementById("ai-chat-window");
        const popupSuggestionArea = document.getElementById("popupSuggestionArea");

        // í˜„ì¬ íŒì—… ëª¨ë“œ ìƒíƒœ (ê¸°ë³¸ê°’: chat)
        let currentPopupMode = 'chat';

        // íŒì—… í† ê¸€ í•¨ìˆ˜
        function toggleAiPopup() {
            if (aiChatWindow.style.display === "none" || aiChatWindow.style.display === "") {
                aiChatWindow.style.display = "flex";
                setTimeout(() => popupMessageInput.focus(), 100);
            } else {
                aiChatWindow.style.display = "none";
            }
        }

        // [ì¶”ê°€] íŒì—… ëª¨ë“œ ì„¤ì • í•¨ìˆ˜
        function setPopupMode(mode) {
            currentPopupMode = mode;

            // íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬
            document.getElementById('popup-tab-chat').classList.toggle('active', mode === 'chat');
            document.getElementById('popup-tab-recommend').classList.toggle('active', mode === 'recommend');
			document.getElementById('popup-tab-policy').classList.toggle('active', mode === 'policy');
			document.getElementById('popup-tab-term').classList.toggle('active', mode === 'term');

            // UI ë³€ê²½ (í”Œë ˆì´ìŠ¤í™€ë” ë° ì¶”ì²œ ë²„íŠ¼)
            if (mode === 'chat') {
                popupMessageInput.placeholder = "ê¶ê¸ˆí•œ ì§€ì—­ì´ë‚˜ ë§¤ë¬¼ì„ ì…ë ¥í•˜ì„¸ìš”...";
                popupSuggestionArea.innerHTML = `
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì„œì›êµ¬ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ì§€ì—­ ê±°ë˜ë‚´ì—­</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì§€ì›°ì‹œí‹° ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ê±´ë¬¼ ê±°ë˜ë‚´ì—­</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ê±°ì£¼ì ì¸ ì¸¡ë©´ì—ì„œ ì„œì›êµ¬ ì–´ë•Œ?')">ê±°ì£¼ê°€ì¹˜</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì„œì›êµ¬ íˆ¬ìí•˜ê¸° ì¢‹ì•„?')">íˆ¬ìì „ë§</button>
                `;
            } else if (mode === 'recommend') {
                popupMessageInput.placeholder = "ê²Œì‹œê¸€ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”...";
                popupSuggestionArea.innerHTML = `
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ìš”ì¦˜ ë¶€ë™ì‚° ì •ì±… ì§ˆë¬¸ ì¶”ì²œ')">ì •ì±… ê´€ë ¨ ì§ˆë¬¸</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì²­ì£¼ ì§€ì—­ í˜¸ì¬ ê¸€ì“°ê¸°')">ì§€ì—­ í˜¸ì¬</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì „ì„¸ ì‚¬ê¸° ì˜ˆë°© íŒ')">ì „ì„¸ ì‚¬ê¸° ì˜ˆë°©</button>
                    <button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ìƒì•  ì²« ì£¼íƒ êµ¬ë§¤ ì¡°ì–¸')">ì²« ì£¼íƒ êµ¬ë§¤</button>
                `;
            } else if (mode === 'policy') {
				popupMessageInput.placeholder = "ê¶ê¸ˆí•œ ì •ì±… ì£¼ì œë‚˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...";
				popupSuggestionArea.innerHTML = `
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì²­ë…„ì„ ëŒ€ìƒìœ¼ë¡œ í•œ ì •ì±…ë“¤ì€ ì–´ë–¤ê²Œ ìˆì–´?')">ì²­ë…„ ì •ì±…</button>
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì²­ì†Œë…„ ê´€ë ¨ ì •ì±…ë“¤ ì•Œë ¤ì¤˜')">ì²­ì†Œë…„ ì •ì±…</button>
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ì£¼íƒ ê´€ë ¨ ì •ì±… ì§„í–‰ì¤‘ì¸ê±° ìˆì–´?')">ì£¼íƒ ì •ì±…</button>
				`
			} else if (mode === 'term') {
				popupMessageInput.placeholder = "ê¶ê¸ˆí•œ ìš©ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...";
				popupSuggestionArea.innerHTML = `
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ê°€ë“±ê¸°ë‹´ë³´ê°€ ë¬´ìŠ¨ ëœ»ì´ì•¼?')">ê°€ë“±ê¸°ë‹´ë³´ë€?</button>
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ë°©í™”ì§€êµ¬ì— ëŒ€í•´ì„œ ì„¤ëª…í•´ì¤˜')">ë°©í™”ì§€êµ¬ë€?</button>
					<button class="ai-popup-suggestion-btn" onclick="fillPopupInput('ììœ ì¬ëŸ‰ì´ ëŒ€ì²´ ë­ì•¼?')">ììœ ì¬ëŸ‰ì´ë€?</button>
				`
			}
        }

        // [ì¶”ê°€] í…ìŠ¤íŠ¸ ì…ë ¥ ì±„ìš°ê¸° ë° ë†’ì´ ì¡°ì ˆ
        function fillPopupInput(text) {
            popupMessageInput.value = text;
            popupMessageInput.focus();
            resizePopupTextarea(popupMessageInput);
        }

        // í…ìŠ¤íŠ¸ ë†’ì´ ìë™ ì¡°ì ˆ
        function resizePopupTextarea(el) {
            el.style.height = "auto";
            el.style.height = (el.scrollHeight < 80 ? el.scrollHeight : 80) + "px";
        }

        popupMessageInput.addEventListener("input", function() {
            resizePopupTextarea(this);
        });

        // ì—”í„°í‚¤ ì „ì†¡
        popupMessageInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendPopupMessage();
            }
        });

        popupSendBtn.addEventListener("click", sendPopupMessage);

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        async function sendPopupMessage() {
            const msg = popupMessageInput.value.trim();
            if (!msg) return;

            appendPopupMessage("user", msg);
            popupMessageInput.value = "";
            popupMessageInput.style.height = "40px";

            const loadingEl = appendPopupMessage("loading", "ë‹µë³€ ìƒì„± ì¤‘...");
			
			
			let url = "";
			
            // ëª¨ë“œì— ë”°ë¼ ìš”ì²­ URL ê²°ì •
			if (currentPopupMode === 'chat') { url = "/ai/chat"; }
			else if (currentPopupMode == 'recommend') { url = "/ai/recommend"; }
			else if (currentPopupMode == 'policy') { url = "/ai/policy"; }
			else if (currentPopupMode == 'term') { url = "/ai/term"; }

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: msg })
                });

                const text = await res.text();

                if (!res.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜ : ${res.status}`);
                }

                loadingEl.remove();
                appendPopupMessage("model", text);

            } catch (error) {
                const bubble = loadingEl.querySelector('.popup-message-bubble');
                if (bubble) {
                    bubble.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message;
                }
                loadingEl.classList.remove("loading");
                loadingEl.classList.add("model");
            }
        }
		
		function formatMessage(text) {
			// ë§í¬ êµ¬í˜„
			let formatted = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_self" style="color: #add8e6; text-decoration: underline; font-weight: bold;">$1</a>');
			// ë³¼ë“œì²´ êµ¬í˜„
	        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
			// ### ì²˜ë¦¬
			formatted = formatted.replace(/^### (.*$)/gm, '<h3 style="margin: 8px 0 5px 0; font-size: 16px; font-weight: bold; color: #fff;">$1</h3>');
			// ## ì²˜ë¦¬
			formatted = formatted.replace(/^## (.*$)/gm, '<h2 style="margin: 15px 0 10px 0; font-size: 18px; font-weight: bold; border-bottom: 1px solid #555; padding-bottom: 5px; color: #54c700;">$1</h2>');
			// ì¤„ë°”ê¿ˆ ë³€í™˜
	        formatted = formatted.replace(/\n/g, '<br>');
	
	        return formatted;
		}

        function appendPopupMessage(role, text) {
            const messageRow = document.createElement("div");
            messageRow.className = `popup-message-row ${role}`;

            const messageBubble = document.createElement("div");
            messageBubble.className = "popup-message-bubble";
			
			if (role === 'model') {
                messageBubble.innerHTML = formatMessage(text); 
            } else {
                messageBubble.textContent = text;
            }

            messageRow.appendChild(messageBubble);
            popupChatBox.appendChild(messageRow);
            popupChatBox.scrollTop = popupChatBox.scrollHeight;

            return messageRow;
        }
    </script>
</div>
</html>