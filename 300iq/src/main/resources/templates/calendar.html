<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ì²­ì•½ ìº˜ë¦°ë”</title>
</head>
<body>

    <div layout:fragment="content"> 
        <div th:replace="~{fragments/sidebar :: sidebar(activeMenu='calendar')}"></div>
        <div class="right-content">
            <h2 class="border-bottom py-2">ğŸ“… ì²­ì•½ ìº˜ë¦°ë”</h2>
            <div class="filter-buttons my-3">
                <button id="filter-all" class="btn btn-primary">ì „ì²´</button>
                <button id="filter-rank-special" class="btn btn-warning">íŠ¹ë³„ê³µê¸‰</button>
                <button id="filter-rank-1" class="btn btn-info">1ìˆœìœ„</button>
                <button id="filter-rank-2" class="btn btn-success">2ìˆœìœ„</button>
                <button id="filter-rank-unranked" class="btn btn-secondary">ë¬´ìˆœìœ„</button>
            </div>
            <div id='calendar-container'>
                <div id='calendar'></div>
            </div>
        </div> 

        <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl"> <div class="modal-content" style="height: 90vh;"> <div class="modal-header">
                        <h5 class="modal-title" id="pdfModalLabel">PDF ë¯¸ë¦¬ë³´ê¸°</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <iframe id="pdf-iframe" src="about:blank" width="100%" height="100%" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /* <![CDATA[ */
            
            document.addEventListener('DOMContentLoaded', function() {
            
                const allEvents = JSON.parse(/*[[${eventsJson}]]*/ '[]');
                const calendarEl = document.getElementById('calendar');
                
                // ======== [ 2. ëª¨ë‹¬ ê°ì²´ ë¯¸ë¦¬ ì¤€ë¹„ ] ========
                const pdfModalEl = document.getElementById('pdfModal');
                const pdfModal = new bootstrap.Modal(pdfModalEl);
                const pdfIframe = document.getElementById('pdf-iframe');
                const pdfModalLabel = document.getElementById('pdfModalLabel');
                // ==========================================

                if (calendarEl) {
                    const calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth', 
                        locale: 'ko',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,dayGridWeek'
                        },
                        events: allEvents,
                        height: '85vh', // ë°°ìœ¨ ë¬¸ì œ í•´ê²° (ìœ ì§€)

                        // ======== [ 3. eventClick í•¸ë“¤ëŸ¬ ìˆ˜ì • ] ========
                        eventClick: function(info) {
                            // 1. ê¸°ë³¸ ë™ì‘(ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°)ì„ ë§‰ìŠµë‹ˆë‹¤.
                            info.jsEvent.preventDefault(); 
						
                            // 2. DTOì˜ url ì†ì„±ì— PDF ê²½ë¡œê°€ ìˆëŠ”ì§€ í™•ì¸
                            if (info.event.url) {
								const popupWidth = 800;
								                                const popupHeight = 600;

								                                // 3. ì‚¬ìš©ìì˜ ëª¨ë‹ˆí„° í•´ìƒë„ì—ì„œ íŒì—…ì´ ì¤‘ì•™ì— ì˜¤ë„ë¡ left, top ê°’ ê³„ì‚°
								                                const popupLeft = (window.screen.width / 2) - (popupWidth / 2);
								                                const popupTop = (window.screen.height / 2) - (popupHeight / 2);
								                                
								                                // 4. ê³„ì‚°ëœ left, top ê°’ì„ í¬í•¨í•˜ì—¬ íŒì—…ì„ ì—½ë‹ˆë‹¤.
								                                window.open(
								                                    info.event.url, 
								                                    "_blank", 
								                                    `width=${popupWidth},height=${popupHeight},left=${popupLeft},top=${popupTop}`
								                                );
                             
                            } else {
                                alert(info.event.title + '\n(ì—°ê²°ëœ PDF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤)');
                            }
                        }
                        // 'eventDidMount'ëŠ” ì‚­ì œ (ë” ì´ìƒ í•„ìš” ì—†ìŒ)
                        // =============================================
                    });
    
                    calendar.render();

                    // ======== [ 4. ëª¨ë‹¬ì´ ë‹«í ë•Œ PDF ì–¸ë¡œë“œ ] ========
                    // (ë©”ëª¨ë¦¬ ì ˆì•½ì„ ìœ„í•´)
                    pdfModalEl.addEventListener('hidden.bs.modal', function () {
                        pdfIframe.src = 'about:blank'; // iframe ë¹„ìš°ê¸°
                    });
                    // ===============================================
    
                    // --- í•„í„°ë§ ê¸°ëŠ¥ (ìœ ì§€) ---
                    document.getElementById('filter-all').addEventListener('click', function() {
                        calendar.removeAllEvents();
                        calendar.addEventSource(allEvents);
                    });
    
                    document.getElementById('filter-rank-special').addEventListener('click', function() {
                        const filteredEvents = allEvents.filter(event => event.className === 'rank-special');
                        calendar.removeAllEvents();
                        calendar.addEventSource(filteredEvents);
                    });
    
                    document.getElementById('filter-rank-1').addEventListener('click', function() {
                        const filteredEvents = allEvents.filter(event => event.className === 'rank-1');
                        calendar.removeAllEvents();
                        calendar.addEventSource(filteredEvents);
                    });
                    
                    document.getElementById('filter-rank-2').addEventListener('click', function() {
                        const filteredEvents = allEvents.filter(event => event.className === 'rank-2');
                        calendar.removeAllEvents();
                        calendar.addEventSource(filteredEvents);
                    });
    
                    document.getElementById('filter-rank-unranked').addEventListener('click', function() {
                        const filteredEvents = allEvents.filter(event => event.className === 'rank-unranked');
                        calendar.removeAllEvents();
                        calendar.addEventSource(filteredEvents);
                    });
    
                } else {
                    console.error("ìº˜ë¦°ë”ë¥¼ í‘œì‹œí•  '#calendar' ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            
            }); // <-- DOMContentLoaded ë‹«ê¸°
            
            /* ]]> */
        </script>
    </th:block>

</body>
</html>