<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>자료 분석</title>
</head>
<body>

<div layout:fragment="content">

    <div th:replace="~{fragments/sidebar :: sidebar(activeMenu='analysis')}"></div>

    <div class="right-content">   
         
        <h3 style="font-weight: 700;">자료 분석하기</h3>
        <p class="text-body-secondary">청주시 부동산 지수 및 평균 가격을 차트로 확인합니다.</p>
        
        <div class="row mb-4">
			<div class="col-md-12">
				<div class="card shadow-sm bg-light">
                    <div class="card-body">
                        <form class="row align-items-center g-3">
                            <div class="col-auto">
                                <label for="guFilter" class="col-form-label text-dark" >구</label>
                            </div>
                            <div class="col-auto">
                                <select id="guFilter" class="form-select" style="width: 100px;" onchange="updateDongFilter(); drawChart();">
                                    <option value="전체">전체</option>
                                    <option value="상당구">상당구</option>
                                    <option value="서원구">서원구</option>
                                    <option value="청원구">청원구</option>
                                    <option value="흥덕구">흥덕구</option>
                                </select>
                            </div>

                            <div class="col-auto">
                                <label for="dongFilter" class="col-form-label text-dark">읍면동</label>
                            </div>
                            <div class="col-auto">
                                <select id="dongFilter" class="form-select" style="width: 100px;" onchange="drawChart()">
                                    <option value="전체">전체</option>
                                </select>
                            </div>

                            <div class="col-auto">
                                <label for="buildingFilter" class="col-form-label text-dark">건물 종류</label>
                            </div>
                            <div class="col-auto">
                                <select id="buildingFilter" class="form-select" style="width: 130px;" onchange="drawChart()">
                                    <option value="아파트">아파트</option>
                                    <option value="연립다세대">연립다세대</option>
                                    <option value="오피스텔">오피스텔</option>
                                    <option value="단독다가구">단독다가구</option>
                                </select>
                            </div>
                            
                            <div class="col-auto">
                                <label for="transactionFilter" class="col-form-label text-dark">거래 종류</label>
                            </div>
                            <div class="col-auto">
                                <select id="transactionFilter" class="form-select" style="width: 100px;" onchange="drawChart()">
                                    <option value="매매">매매</option>
                                    <option value="전세">전세</option>
                                    <option value="월세">월세</option>
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
			</div>
		</div>
        <div class="row">
			<div class="col-md-12">
				<div class="card shadow-sm mb-4">
					<div class="card-header" style="background-color: #54c700 !important;">
						<h5 class="mb-0" style="color: #121212;">청주시 구/읍면동별 월별 평당 평균 가격 추이</h5>
					</div>
					<div class="card-body">
						<div id="cheongju-avg-price-chart" style="width: 100%;"></div> 
					</div>
				</div>
			</div>
		</div>
    	    <div class="row mt-5" id="total-data-display-area">
			<div class="col-mb-12">
				<div class="card shadow-sm">
					<div class="card-header" style="background-color: #54c700 !important;">
						<h5 class="mb-0" style="color: #121212;">선택된 시의 상세 거래 내역</h5>
					</div>
					<div class="card-body">
						<div id="total-data-table-container">
							<p class="text-body-secondary" id="initial-data-message"> 
								차트의 데이터 점을 클릭하면 해당 시점의 상세 거래 내역 일부가 여기에 표시됩니다.
							</p>
						</div>
					</div>
				</div>
			</div>		
		</div>
    </div>
</div>

<th:block layout:fragment="script">
    
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    
    <script th:inline="javascript">
        const rawDataString = '[[${avgPriceData}]]';
        let rawData;
        let dongListByGu = {}; 
        
       
        const FIXED_DONG_LISTS = {
            "상당구": ["전체", "용암동", "금천동", "방서동", "탑동"], // 예시 4개 동 + 전체
            "서원구": ["전체", "분평동", "사창동", "모충동", "산남동"],
            "청원구": ["전체", "오창읍", "내수읍", "우암동", "율량동"],
            "흥덕구": ["전체", "복대동", "가경동", "봉명동", "운천동"]
        };

        (function initialize() {
            try {
                rawData = JSON.parse(rawDataString);
            } catch (e) {
                console.error("ERROR: Failed to parse rawData JSON string:", e);
                document.getElementById('cheongju-avg-price-chart').innerHTML = '<p class="text-danger">데이터 파싱 오류! 콘솔 확인 요망.</p>';
                return;
            }
            
            if (!rawData || rawData.length === 0) {
                document.getElementById('cheongju-avg-price-chart').innerHTML = '<p class="text-danger">표시할 데이터가 없습니다. (DB 확인 필요)</p>';
                return;
            }
            
            dongListByGu = FIXED_DONG_LISTS;
            updateDongFilter(); 
        })(); 

        // generateDongList 함수는 더 이상 동적 생성을 하지 않으므로 제거됩니다.

        function updateDongFilter() {
            const guSelect = document.getElementById('guFilter');
            const dongSelect = document.getElementById('dongFilter');
            const selectedGu = guSelect.value;

            dongSelect.innerHTML = '';
            
            let dongs = ['전체'];
            if (selectedGu !== '전체' && dongListByGu[selectedGu]) {
                // ⭐ [수정됨]: FIXED_DONG_LISTS 사용
                dongs = dongListByGu[selectedGu]; 
                dongSelect.disabled = false;
            } else if (selectedGu === '전체') {
                dongs = ['전체'];
                dongSelect.disabled = true;
            }

            dongs.forEach(dong => {
                const option = document.createElement('option');
                option.value = dong;
                option.textContent = dong;
                dongSelect.appendChild(option);
            });
            
            drawChart();
        }

        function drawChart() {
            if (!rawData || rawData.length === 0) return;

            const guFilter = document.getElementById('guFilter').value;
            const dongFilter = document.getElementById('dongFilter').value;
            const buildingFilter = document.getElementById('buildingFilter').value;
            const transactionFilter = document.getElementById('transactionFilter').value;
            
            // 1. 데이터 가공 및 필터링
            const chartData = rawData.map(item => {
                try {
                    const year = item.id.contractMonth.substring(0, 4);
                    const month = item.id.contractMonth.substring(4, 6);
                    const dateString = year + '-' + month + '-01'; 

                    const seriesKey = item.id.gu + '::' + item.id.dong + '::' + item.id.buildingType + '::' + item.id.transactionType;
                    
                    return {
                        date: dateString, 
                        구: item.id.gu,
                        읍면동: item.id.dong,
                        건물: item.id.buildingType,
                        거래유형: item.id.transactionType,
                        평균가격: item.avgPricePerPyeong,
                        계열: seriesKey, 
					    sigungu: item.sigungu
                    };
                } catch (e) {
                    console.error("Data mapping error:", e, item);
                    return null;
                }
            }).filter(item => {
                if (!item || item.평균가격 <= 0 || !item.구 || !item.date) return false;

                // 1. 구 필터 적용
                const passGu = guFilter === '전체' || item.구 === guFilter;
                if (!passGu) return false;
                
                // 2. 읍면동 필터 적용 (핵심 로직)
                let passDong;
                
                if (guFilter === '전체') {
                    // Gu='전체' 선택 시: 동은 반드시 '전체' 집계 데이터만 통과 (구별 비교)
                    passDong = item.읍면동 === '전체'; 
                } else if (dongFilter === '전체') {
                    const fixedDongsForGu = FIXED_DONG_LISTS[guFilter] || ['전체'];
                    passDong = fixedDongsForGu.includes(item.읍면동);
                    
                } else {
                    // 특정 Gu & 특정 Dong 선택 시: 해당 동 데이터만 통과 (단일 선)
                    passDong = item.읍면동 === dongFilter;
                }
                if (!passDong) return false;
                
                // 3. 건물 종류 필터 적용 (선택된 값만 통과)
                const passBuilding = item.건물 === buildingFilter;
                if (!passBuilding) return false;

                // 4. 거래 종류 필터 적용 (선택된 값만 통과)
                const passTransaction = item.거래유형 === transactionFilter;
                
                return passBuilding && passTransaction;
            }); 
            
            // 2. 차트 사양 정의
            const titleText = `${guFilter === '전체' ? '청주시 전체' : guFilter} ${dongFilter === '전체' ? (guFilter === '전체' ? '전체' : '대표 읍면동별') : dongFilter} | ${buildingFilter} ${transactionFilter} 추이`;
            
            const spec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
				"background": "#1e1e1e",
                "title": titleText,
                "width": "container",
                "height": 400,
                "data": { "values": chartData },
                "layer": [
				{
					"mark": "line",
	                "encoding": {
	                    "x": {"field": "date", "type": "temporal", "title": "월별", "axis": {"format": "%Y년 %m월","tickCount": 6, "grid": false}},
						"y": {"field": "평균가격", "type": "quantitative", "title": "평당 평균 가격(만원)", "axis": {"format": ",.0f","tickCount": 6, "grid": false}},	                    
						"color": {"field": "계열", "type": "nominal", "title": "분석 계열"}, 
	                    "tooltip": [
	                        {"field": "date", "type": "temporal", "title": "월", "format": "%Y년 %m월"},
	                        {"field": "구", "type": "nominal", "title": "구"},
	                        {"field": "읍면동", "type": "nominal", "title": "읍면동"},
	                        {"field": "건물", "type": "nominal", "title": "건물 유형"},
	                        {"field": "거래유형", "type": "nominal", "title": "거래 유형"},
	                        {"field": "평균가격", "type": "quantitative", "title": "평당가격(만원)", "format": ",.0f"}
	                    ]
	                }
				},
					{
						"mark": {"type": "point", "size": 20, "opacity": 1.0, "name": "data-point"},
		                "encoding": {
		                    "x": {"field": "date", "type": "temporal","title": null},
		                    "y": {"field": "평균가격", "type": "quantitative","title": null},
		                    "color": {"field": "계열", "type": "nominal"}, 
		                    "tooltip": [
		                        {"field": "date", "type": "temporal", "title": "월", "format": "%Y년 %m월"},
		                        {"field": "구", "type": "nominal", "title": "구"},
		                        {"field": "읍면동", "type": "nominal", "title": "읍면동"},
		                        {"field": "건물", "type": "nominal", "title": "건물 유형"},
		                        {"field": "거래유형", "type": "nominal", "title": "거래 유형"},
		                        {"field": "평균가격", "type": "quantitative", "title": "평당가격(만원)", "format": ",.0f"}
		                    ]
		                },
					}
				],
				"encoding": {},
                "resolve": {"scale": {"y": "independent"}},
                "config": {
                    "view": {"stroke": "transparent"},
                    "title": {"fontSize": 18, "color": "#e0e0e0"},
					"axis": {"labelColor": "#e0e0e0", "titleColor": "#e0e0e0"},
					"legend": {"labelColor": "#e0e0e0", "titleColor": "#e0e0e0"}
                }
            };

            // 3. 차트 렌더링
            const chartContainer = document.getElementById('cheongju-avg-price-chart');
            if (chartData.length > 0) {
                vegaEmbed('#cheongju-avg-price-chart', spec, { 
                    actions: false 
                }).then(result=>{
					result.view.addEventListener('click', (event, item)=>{
						const dataItem = item && item.datum ? item.datum : null;						
						if(item && item.mark && item.mark.name === 'layer_1_marks' && item.datum){							
							console.log("DATUM (2):", item.datum.datum);
							showTotalDataExamples(dataItem);
						}
					});
				}).catch(console.error);
            } else {
                chartContainer.innerHTML = `<p class="text-danger">선택한 필터 조건(${titleText} 기준)에 맞는 데이터가 없습니다.</p>`;
            }
        }
		async function showTotalDataExamples(datum){
			if(!datum||!datum.구){
				console.error("[ERROR] showTotalDataExamples: Invalid or incomplete data object received:", datum);
                const container = document.getElementById('total-data-table-container');
                container.innerHTML = '<p class="text-danger">상세 거래 내역을 표시하기 위한 기본 정보가 누락되었습니다. 다른 데이터 포인트를 클릭해 주세요.</p>';
                return;
			}
			
			console.log("--- SHOW FUNCTION STARTED ---");
			const container = document.getElementById('total-data-table-container');
			
			const dateObject = new Date(datum.date);
	        const year = dateObject.getFullYear();
	        const month = (dateObject.getMonth() + 1).toString().padStart(2, '0'); 
	        const contractMonth = year + month;
			
			container.innerHTML = `<p class="text-info">선택된 차트(${datum.구} ${datum.읍면동}, ${year}년 ${month}월 기준)의 상세 거래 내역을 불러오는 중입니다...</p>`;			
			const gu = datum.구;
			const dong = datum.읍면동;
            const buildingType = datum.건물;
			const specificTransactionType = datum.거래유형;
			const sigungu = datum.sigungu;
			const url = `/analysis/getDetailTransactions?sigungu=${sigungu}&buildingType=${buildingType}&contractMonth=${contractMonth}&transactionType=${specificTransactionType}`;			
			try{
				const response =await fetch(url);
				
				if(!response.ok){
					throw new Error(`HTTP error! : ${response.status}`);
				}
				const rawText = await response.text();
				console.log("[FETCH DEBUG] Raw Response Start:", rawText.substring(0, 100) + '...');
				
				const transactions = JSON.parse(rawText);
				
				console.log("[DETAIL DEBUG] Received transactions:", transactions);
				console.log("[DETAIL DEBUG] Transaction count:", transactions.length);
				renderTransactionTable(transactions, gu, dong , contractMonth);
				
			}catch (error){
				console.error("Error fetching detail transactions:", error);
				container.innerHTML = `<p class="text-danger">상세 거래 내역을 불러오는데 실패했습니다: ${error.message}</p>`;
			}
		}
		
		function renderTransactionTable(transactions, gu, dong , contractMonth){
			const container = document.getElementById('total-data-table-container');
			
			if(!transactions || transactions.length === 0){
				container.innerHTML = `<p class="text-body-secondary">선택된 시점(${gu} ${dong}, ${contractMonth.substring(0, 4)}년 ${contractMonth.substring(4, 6)}월)에 해당하는 상세 거래 내역이 없습니다.</p>`;
				return;
			}
			let tableHtml = `<p class="text-body-secondary">총 <strong>${transactions.length}건</strong>의 상세 거래 내역이 조회되었습니다. (일부 정보가 생략될 수 있습니다.)</p>`;
			tableHtml += `
				<div class="table-responsive" style="max-height :400px; overflow-y:auto;">
				<table class="table table-sm table-striped table-hover">
					<thead class="table-dark sticky-top">
						<tr>
							<th>주소</th>
                            <th>전용면적(㎡)</th>
                            <th>계약일</th>
                            <th>거래유형</th>
                            <th>거래/보증금(만원)</th>
                            <th>월세(만원)</th>
                        </tr>
                    </thead>
                    <tbody>
            `; 
			
			transactions.forEach(tx => {
				const priceFormatted = tx.price.toLocaleString('ko-KR');
                const rentFormatted = tx.rent.toLocaleString('ko-KR');
                const typeMatch = tx.transactionType.match(/\((.*?)\)/);
                let displayType = typeMatch ? typeMatch[1] : tx.transactionType;

                tableHtml += `
                    <tr>
						<td>${tx.address || '주소 미상'} ${tx.buildingName}</td> 
                        <td class="text-center">${tx.area && !isNaN(tx.area) ? tx.area.toFixed(2) : '0.00'}</td>
                        <td>${tx.contractDate.substring(0, 4)}년 ${tx.contractDate.substring(4, 6)}월 ${tx.contractDate.substring(6, 8)}일</td> 
                        <td>${tx.transactionType || '-'}</td> 
                        <td>${priceFormatted}</td>
                        <td>${tx.rent > 0 ? rentFormatted : '0'}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
		}

		
    </script>
</th:block>

</body>
</html>