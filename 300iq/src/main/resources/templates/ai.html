<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
  <head>
      <title>AI 상담</title>
      <style>

		  .right-content .card{
			background-color : #ffffff !important;
			border : none;
			box-shadow : 0 4px 12px rgba(0, 0, 0, 0.05);
		  }
          #chatBox {
              padding: 20px;
              overflow-y: auto;
              display: flex;
              flex-direction: column;
              gap: 15px;
          }

          .message-row {
              display: flex;
          }

          .message-bubble {
              max-width: 75%;
              padding: 12px 18px;
              border-radius: 20px;
              line-height: 1.6;
              word-wrap: break-word;
              font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
          }

          .message-row.user {
              justify-content: flex-end;
          }
          .message-row.user .message-bubble {
              background-color: #54c700;
              color: white;
              border-bottom-right-radius: 5px;
          }
          
          .user { color: inherit; margin: 0; }
          .model { color: inherit; margin: 0; }

          .message-row.model {
              justify-content: flex-start;
          }
          .message-row.model .message-bubble {
              background-color: #f1f1f1;
              color: #333;
              border-bottom-left-radius: 5px;
              
              white-space: pre-wrap; /* AI 답변 가독성 */
          }

          .message-row.loading {
              justify-content: flex-start;
          }
          .message-row.loading .message-bubble {
              background-color: #f1f1f1;
              color: #888;
              font-style: italic;
          }
          .loading { color: inherit; margin: 0; font-style: normal; }


          .input-area { 
              display: flex; 
              gap: 10px; 
              align-items: center;
          }

          .input-area textarea {
              flex-grow: 1;
              border: 1px solid #ccc;
              border-radius: 20px;
              padding: 10px 18px;
              height: 40px;
              max-height: 120px;
              font-size: 15px;
              resize: none; 
              font-family: inherit;
              line-height: 1.5;
              color: #ffffff;
              margin-top: 0;
          }
          .input-area textarea:focus {
              outline: none;
              border-color: #54c700;
          }

          .input-area button {
              height: 40px;
              padding: 0 20px;
              border: none;
              border-radius: 20px;
              background-color: #54c700;
              color: white;
              font-size: 15px;
              font-weight: 600;
              cursor: pointer;
              margin-top: 0;
              white-space: nowrap;
          }
          .input-area button:hover {
              background-color: #0056b3;
          }

      </style>
  </head>

<body>
	<div layout:fragment="content" class="container my-5">

	    <div th:replace="~{fragments/sidebar :: sidebar(activeMenu='ai')}"></div>

	    <div class="right-content">
	        <div class="row justify-content-center">
	            <div class="col-md-10">
	                <h1 class="text-center mb-4">AI 부동산 상담</h1>
	                <p class="text-center text-body-secondary mb-5">
	                    청주시 부동산 데이터에 기반하여 Gemini AI가 답변해 드립니다.
	                </p>
	               
	                        
                    <div id="chatBox" class="flex-grow-1 mb-3">
                        <div th:each="msg : ${chatHistory}" class="message-row" th:classappend="${msg.role}">
                            <div class="message-bubble" th:text="${msg.text}"></div>
                        </div>
                        
                        <div class="message-row model" th:if="${#lists.isEmpty(chatHistory)}">
                            <div class="message-bubble">안녕하세요! AI 부동산 상담 챗봇입니다. 무엇이 궁금하신가요? (예: 서원구 거래 내역 알려줘)</div>
                        </div>
                    </div>

                    <div class="input-area">
                        <textarea id="message" placeholder="메시지를 입력하세요..."></textarea>
                        <button id="sendBtn">전송</button>
                    </div>
					
                    <script>
					    const messageInput = document.getElementById("message");
					    const chatBox = document.getElementById("chatBox");
					    const sendBtn = document.getElementById("sendBtn");
					
                        // 페이지 로드 시 스크롤 맨 아래로
                        chatBox.scrollTop = chatBox.scrollHeight;

					    messageInput.addEventListener("keydown", function(e) {
					        if (e.key === "Enter" && !e.shiftKey) {
					            e.preventDefault();
					            sendMessage();
					        }
					    });
					
					    sendBtn.addEventListener("click", sendMessage);

                        messageInput.addEventListener("input", function() {
                            this.style.height = "auto";
                            this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + "px";
                        });
					
					    async function sendMessage() {
					        const msg = messageInput.value.trim();
					        if (!msg.trim()) return;
					
					        appendMessage("user", msg);
					        messageInput.value = "";
                            messageInput.style.height = "40px";
					
					        const loadingEl = appendMessage("loading", "답변 생성 중...");
					
					        try {
					            const res = await fetch("/ai/chat", {
					                method: "POST",
					                headers: { "Content-Type": "application/json" },
					                body: JSON.stringify({ message: msg })
					            });
					
					            const text = await res.text();

					            if (!res.ok) {
                                    throw new Error(`HTTP 오류 : ${res.status}`);
					            }
								
					            loadingEl.remove();
					            appendMessage("model", text);
					
					        } catch (error) {
                                const bubble = loadingEl.querySelector('.message-bubble');
                                if (bubble) {
                                    bubble.textContent = error.message;
                                }
					            loadingEl.classList.remove("loading");
					            loadingEl.classList.add("model");
					        }
					    }
					
					    function appendMessage(role, text) {
                            const messageRow = document.createElement("div");
                            messageRow.className = `message-row ${role}`;

                            const messageBubble = document.createElement("div");
                            messageBubble.className = "message-bubble";
                            
                            messageBubble.textContent = text;

                            messageRow.appendChild(messageBubble);
                            chatBox.appendChild(messageRow);
                            chatBox.scrollTop = chatBox.scrollHeight;
                            
                            return messageRow;
					    }
					</script>
	            </div>
	        </div>
	    </div>
	</div>

</body>
</html>