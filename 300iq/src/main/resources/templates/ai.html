<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
  <head>
      <title>AI ìƒë‹´</title>
      <style>
          .right-content .card{
            background-color : #ffffff !important;
            border : none;
            box-shadow : 0 4px 12px rgba(0, 0, 0, 0.05);
          }
          #chatBox {
              padding: 20px;
              overflow-y: auto;
              display: flex;
              flex-direction: column;
              gap: 15px;
              height: 60vh;
              min-height: 400px;
          }

          /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
          .message-row { display: flex; }
          .message-bubble {
              max-width: 75%;
              padding: 12px 18px;
              border-radius: 20px;
              line-height: 1.6;
              word-wrap: break-word;
              font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
          }
          .message-row.user { justify-content: flex-end; }
          .message-row.user .message-bubble {
              background-color: #54c700;
              color: white;
              border-bottom-right-radius: 5px;
          }
          .message-row.model { justify-content: flex-start; }
          .message-row.model .message-bubble {
              background-color: #333;
              color: #f1f1f1;
              border-bottom-left-radius: 5px;
              white-space: pre-wrap;
          }
          .message-row.loading { justify-content: flex-start; }
          .message-row.loading .message-bubble {
              background-color: #f1f1f1;
              color: #888;
              font-style: italic;
          }

          /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
          .input-area { 
              display: flex; 
              gap: 10px; 
              align-items: center;
          }
          .input-area textarea {
              flex-grow: 1;
              border: 1px solid #ccc;
              border-radius: 20px;
              padding: 10px 18px;
              height: 40px;
              max-height: 120px;
              font-size: 15px;
              resize: none; 
              font-family: inherit;
              line-height: 1.5;
              color: #ffffff;
              background-color: transparent;
              margin-top: 0;
          }
          .input-area textarea:focus {
              outline: none;
              border-color: #54c700;
          }
          .input-area button {
              height: 40px;
              padding: 0 20px;
              border: none;
              border-radius: 20px;
              background-color: #54c700;
              color: white;
              font-size: 15px;
              font-weight: 600;
              cursor: pointer;
              white-space: nowrap;
          }
          .input-area button:hover { background-color: #0056b3; }

          /* í•˜ë‹¨ ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
          .suggestion-area {
              display: flex;
              gap: 8px;
              margin-top: 10px;
              flex-wrap: wrap;
          }
          .suggestion-btn {
              background-color: rgba(255, 255, 255, 0.1);
              border: 1px solid #555;
              border-radius: 15px;
              padding: 8px 16px;
              font-size: 13px;
              color: #ccc;
              cursor: pointer;
              transition: all 0.2s ease;
          }
          .suggestion-btn:hover {
              border-color: #54c700;
              color: #54c700;
              background-color: rgba(84, 199, 0, 0.1);
          }

          /* [ì‹ ê·œ] ìƒë‹¨ ëª¨ë“œ ì „í™˜ íƒ­ ìŠ¤íƒ€ì¼ */
          .mode-tabs {
              display: flex;
              justify-content: center;
              gap: 10px;
              margin-bottom: 15px;
          }
          .mode-tab-btn {
              background-color: transparent;
              border: 1px solid #555;
              color: #888;
              padding: 8px 20px;
              border-radius: 20px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.3s;
          }
          .mode-tab-btn.active {
              background-color: #54c700;
              color: white;
              border-color: #54c700;
          }

      </style>
  </head>

<body>
    <div layout:fragment="content" class="container my-5">

        <div th:replace="~{fragments/sidebar :: sidebar(activeMenu='ai')}"></div>

        <div class="right-content">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <h1 class="text-center mb-4">AI ë¶€ë™ì‚° ìƒë‹´</h1>
                    
                    <div class="mode-tabs">
                        <button class="mode-tab-btn active" onclick="setMode('chat')" id="btn-chat">ğŸ“Š ë§¤ë¬¼Â·ë¶„ì„ ìƒë‹´</button>
                        <button class="mode-tab-btn" onclick="setMode('recommend')" id="btn-recommend">ğŸ“ ê²Œì‹œê¸€ ì¶”ì²œ</button>
						<button class="mode-tab-btn" onclick="setMode('policy')" id="btn-policy">ğŸ“œ ì •ì±… ì¶”ì²œ</button>
						<button class="mode-tab-btn" onclick="setMode('term')" id="btn-term">ğŸ“• ìš©ì–´ ê²€ìƒ‰</button>
                    </div>

                    <p class="text-center text-body-secondary mb-4" id="mode-desc">
                        ì²­ì£¼ì‹œ ë¶€ë™ì‚° ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ë§¤ë¬¼ ê²€ìƒ‰ ë° ê°€ì¹˜ ë¶„ì„ì„ í•´ë“œë¦½ë‹ˆë‹¤.
                    </p>
                           
                    <div id="chatBox" class="flex-grow-1 mb-3">
                        <div th:each="msg : ${chatHistory}" class="message-row" th:classappend="${msg.role}">
                            <div class="message-bubble" th:text="${msg.text}"></div>
                        </div>
                        
                        <div class="message-row model" th:if="${#lists.isEmpty(chatHistory)}">
                            <div class="message-bubble">ì•ˆë…•í•˜ì„¸ìš”! AI ì±—ë´‡ì…ë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ìƒë‹´ ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.</div>
                        </div>
                    </div>

                    <div class="input-area">
                        <textarea id="message" placeholder="ê¶ê¸ˆí•œ ì§€ì—­ì´ë‚˜ ë§¤ë¬¼ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <button id="sendBtn">ì „ì†¡</button>
                    </div>
                    
                    <div class="suggestion-area" id="suggestionArea">
						<button class="suggestion-btn" onclick="fillInput('ì„œì›êµ¬ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ì§€ì—­ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­</button>
                        <button class="suggestion-btn" onclick="fillInput('ì§€ì›°ì‹œí‹° ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ê±´ë¬¼ ê±°ë˜ë‚´ì—­</button>
                        <button class="suggestion-btn" onclick="fillInput('ê±°ì£¼ì ì¸ ì¸¡ë©´ì—ì„œ ì„œì›êµ¬ ì–´ë•Œ?')">ê±°ì£¼ ê°€ì¹˜</button>
                        <button class="suggestion-btn" onclick="fillInput('ì„œì›êµ¬ íˆ¬ìí•˜ê¸° ì¢‹ì•„?')">íˆ¬ì ì „ë§</button>
                    </div>
                    
                    <script th:inline="none">
                        const messageInput = document.getElementById("message");
                        const chatBox = document.getElementById("chatBox");
                        const sendBtn = document.getElementById("sendBtn");
                        const suggestionArea = document.getElementById("suggestionArea");
                        const modeDesc = document.getElementById("mode-desc");

                        // í˜„ì¬ ëª¨ë“œ ìƒíƒœ (ê¸°ë³¸ê°’: chat)
                        let currentMode = 'chat';

                        // ëª¨ë“œ ë³€ê²½ í•¨ìˆ˜
                        function setMode(mode) {
                            currentMode = mode;

                            // íƒ­ ìŠ¤íƒ€ì¼ ë³€ê²½
                            document.getElementById('btn-chat').classList.toggle('active', mode === 'chat');
                            document.getElementById('btn-recommend').classList.toggle('active', mode === 'recommend');
							document.getElementById('btn-policy').classList.toggle('active', mode === 'policy');
							document.getElementById('btn-term').classList.toggle('active', mode === 'term');

                            // UI í…ìŠ¤íŠ¸ ë° ì¶”ì²œ ë²„íŠ¼ ë³€ê²½
                            if (mode === 'chat') {
                                modeDesc.textContent = "ì²­ì£¼ì‹œ ë¶€ë™ì‚° ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬ ë§¤ë¬¼ ê²€ìƒ‰ ë° ê°€ì¹˜ ë¶„ì„ì„ í•´ë“œë¦½ë‹ˆë‹¤.";
                                messageInput.placeholder = "ê¶ê¸ˆí•œ ì§€ì—­ì´ë‚˜ ë§¤ë¬¼ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ : ì„œì›êµ¬ ì•„íŒŒíŠ¸)";
                                
                                // ë¶„ì„ ëª¨ë“œìš© ë²„íŠ¼
                                suggestionArea.innerHTML = `
                                    <button class="suggestion-btn" onclick="fillInput('ì„œì›êµ¬ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ì§€ì—­ ì•„íŒŒíŠ¸ ê±°ë˜ë‚´ì—­</button>
                                    <button class="suggestion-btn" onclick="fillInput('ì§€ì›°ì‹œí‹° ê±°ë˜ë‚´ì—­ ì•Œë ¤ì¤˜')">ê±´ë¬¼ ê±°ë˜ë‚´ì—­</button>
                                    <button class="suggestion-btn" onclick="fillInput('ê±°ì£¼ì ì¸ ì¸¡ë©´ì—ì„œ ì„œì›êµ¬ ì–´ë•Œ?')">ê±°ì£¼ ê°€ì¹˜</button>
                                    <button class="suggestion-btn" onclick="fillInput('ì„œì›êµ¬ íˆ¬ìí•˜ê¸° ì¢‹ì•„?')">íˆ¬ì ì „ë§</button>
                                `;
                            } else if (mode === 'recommend') {
                                modeDesc.textContent = "ê´€ì‹¬ìˆëŠ” ì£¼ì œë¥¼ ì…ë ¥í•˜ë©´, ê²Œì‹œíŒì— ì˜¬ë¦´ ë§Œí•œ ì¢‹ì€ ì§ˆë¬¸ 3ê°€ì§€ë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.";
                                messageInput.placeholder = "ê²Œì‹œê¸€ ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ : ë¶€ë™ì‚° ì •ì±…, ê¸ˆë¦¬ ì˜í–¥)";
                                
                                // ì¶”ì²œ ëª¨ë“œìš© ë²„íŠ¼
                                suggestionArea.innerHTML = `
                                    <button class="suggestion-btn" onclick="fillInput('ìš”ì¦˜ ë¶€ë™ì‚° ì •ì±…ì— ëŒ€í•´ ì§ˆë¬¸ ì¶”ì²œí•´ì¤˜')">ë¶€ë™ì‚° ì •ì±… ê´€ë ¨</button>
                                    <button class="suggestion-btn" onclick="fillInput('ì²­ì£¼ í˜¸ì¬ë‚˜ ì „ë§ì— ëŒ€í•œ ê¸€ì„ ì“°ê³  ì‹¶ì–´')">ì²­ì£¼ ì§€ì—­ í˜¸ì¬</button>
                                    <button class="suggestion-btn" onclick="fillInput('ì „ì„¸ ì‚¬ê¸° ì˜ˆë°© íŒ ê³µìœ í•˜ê³  ì‹¶ì–´')">ì „ì„¸ ì‚¬ê¸° ì˜ˆë°©</button>
                                    <button class="suggestion-btn" onclick="fillInput('ìƒì•  ì²« ì£¼íƒ êµ¬ë§¤ ì¡°ì–¸ êµ¬í•˜ê¸°')">ì²« ì£¼íƒ êµ¬ë§¤</button>
                                `;
                            } else if (mode === 'policy') {
								modeDesc.textContent = "ê´€ì‹¬ìˆëŠ” ì •ì±…ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´, í˜„ì¬ ì§„í–‰ì¤‘ì¸ ì •ì±…ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.";
								messageInput.placeholder = "ì •ì±… ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ : ì²­ë…„ ì •ì±…, ëŒ€í•™ìƒ ì •ì±…)"
								
								suggestionArea.innerHTML = `
									<button class="suggestion-btn" onclick="fillInput('ì²­ë…„ì„ ëŒ€ìƒìœ¼ë¡œ í•œ ì •ì±…ë“¤ì€ ì–´ë–¤ê²Œ ìˆì–´?')">ì²­ë…„ ì •ì±…</button>
									<button class="suggestion-btn" onclick="fillInput('ì²­ì†Œë…„ ê´€ë ¨ ì •ì±…ë“¤ ì•Œë ¤ì¤˜')">ì²­ì†Œë…„ ì •ì±…</button>
									<button class="suggestion-btn" onclick="fillInput('ì£¼íƒ ê´€ë ¨ ì •ì±… ì§„í–‰ì¤‘ì¸ê±° ìˆì–´?')">ì£¼íƒ ì •ì±…</button>
								`;
							} else if (mode === 'term') {
								modeDesc.textcontent = "ê¶ê¸ˆí•œ ìš©ì–´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´, ìš©ì–´ì™€ ìš©ì–´ì˜ ì„¤ëª…ì— ëŒ€í•´ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.";
								messageInput.placeholder = "ê¶ê¸ˆí•œ ìš©ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ : ê°€ê±´ë¬¼, ê°€êµ¬)"
								
								suggestionArea.innerHTML = `
									<button class="suggestion-btn" onclick="fillInput('ê°€ë“±ê¸°ë‹´ë³´ê°€ ë¬´ìŠ¨ ëœ»ì´ì•¼?')">ê°€ë“±ê¸°ë‹´ë³´ë€?</button>
									<button class="suggestion-btn" onclick="fillInput('ë°©í™”ì§€êµ¬ì— ëŒ€í•´ì„œ ì„¤ëª…í•´ì¤˜')">ë°©í™”ì§€êµ¬ë€?</button>
									<button class="suggestion-btn" onclick="fillInput('ììœ ì¬ëŸ‰ì´ ëŒ€ì²´ ë­ì•¼?')">ììœ ì¬ëŸ‰ì´ë€?</button>
								`;
							}
                        }

                        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤
                        chatBox.scrollTop = chatBox.scrollHeight;

                        messageInput.addEventListener("keydown", function(e) {
                            if (e.key === "Enter" && !e.shiftKey) {
                                e.preventDefault();
                                sendMessage();
                            }
                        });

                        sendBtn.addEventListener("click", sendMessage);

                        messageInput.addEventListener("input", function() {
                            resizeTextarea(this);
                        });
                        
                        function resizeTextarea(el) {
                            el.style.height = "auto";
                            el.style.height = (el.scrollHeight < 120 ? el.scrollHeight : 120) + "px";
                        }
                        
                        function fillInput(text) {
                            messageInput.value = text;
                            messageInput.focus();
                            resizeTextarea(messageInput);
                        }

                        async function sendMessage() {
                            const msg = messageInput.value.trim();
                            if (!msg) return;

                            appendMessage("user", msg);
                            messageInput.value = "";
                            messageInput.style.height = "40px";

                            const loadingEl = appendMessage("loading", "ë‹µë³€ ìƒì„± ì¤‘...");

							let url = "";
                            // ëª¨ë“œì— ë”°ë¼ ìš”ì²­ URL ê²°ì •
                            if (currentMode === 'chat') { url = "/ai/chat"; }
							else if (currentMode == 'recommend') { url = "/ai/recommend"; }
							else if (currentMode == 'policy') { url = "/ai/policy"; }
							else if (currentMode == 'term') { url = "/ai/term"; }

                            try {
                                const res = await fetch(url, {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ message: msg })
                                });

                                const text = await res.text();

                                if (!res.ok) throw new Error(`HTTP ì˜¤ë¥˜ : ${res.status}`);
                                
                                loadingEl.remove();
                                appendMessage("model", text);

                            } catch (error) {
                                const bubble = loadingEl.querySelector('.message-bubble');
                                if (bubble) bubble.textContent = error.message;
                                loadingEl.classList.remove("loading");
                                loadingEl.classList.add("model");
                            }
                        }
						
						function formatMessage(text) {
							// ë§í¬ êµ¬í˜„
							let formatted = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_self" style="color: #add8e6; text-decoration: underline; font-weight: bold;">$1</a>');
							// ë³¼ë“œì²´ êµ¬í˜„
				            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
							// ### ì²˜ë¦¬
							formatted = formatted.replace(/^### (.*$)/g, '<h3>$1</h3>');
							// ## ì²˜ë¦¬
							formatted = formatted.replace(/^## (.*$)/g, '<h2>$2</h2>');
							// ì¤„ë°”ê¿ˆ ë³€í™˜
				            formatted = formatted.replace(/\n/g, '<br>');

				            return formatted;
						}

                        function appendMessage(role, text) {
                            const messageRow = document.createElement("div");
                            messageRow.className = `message-row ${role}`;
							
                            const messageBubble = document.createElement("div");
							messageBubble.className = "message-bubble";
							
							if (role === 'model') {
				                messageBubble.innerHTML = formatMessage(text); 
				            } else {
				                messageBubble.textContent = text;
				            }

				            messageRow.appendChild(messageBubble);
				            chatBox.appendChild(messageRow);
				            chatBox.scrollTop = chatBox.scrollHeight;

				            return messageRow;
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html>